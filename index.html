<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPhone 粒子系統加強版</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #video-input { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        /* 啟動介面 */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        button {
            padding: 20px 40px; font-size: 20px; cursor: pointer; background: #00ffcc;
            border: none; border-radius: 40px; color: #000; font-weight: bold;
        }
        /* 偵錯視窗：如果出錯這裡會顯示文字 */
        #debug-log {
            position: fixed; bottom: 10px; left: 10px; font-size: 10px; 
            color: #ff0000; z-index: 200; pointer-events: none; max-width: 90%;
        }
    </style>
</head>
<body>

<div id="debug-log">系統日誌: 等待點擊啟動...</div>

<div id="loading-screen" class="overlay">
    <h2 style="margin-bottom: 10px;">3D 手勢粒子系統</h2>
    <p style="color: #888; margin-bottom: 30px;">需開啟相機權限</p>
    <button id="start-btn">點擊開啟系統</button>
</div>

<video id="video-input" playsinline muted autoplay></video>
<div id="container"></div>

<!-- 直接引用 UMD 版本的庫，避免 Import Map 兼容性問題 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
    const logElement = document.getElementById('debug-log');
    function debug(msg) { 
        logElement.innerText = "日誌: " + msg; 
        console.log(msg);
    }

    let scene, camera, renderer, particles, material;
    let expansion = 1.0;

    // --- 1. 初始化 Three.js ---
    function initThree() {
        try {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('container').appendChild(renderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const points = [];
            for (let i = 0; i < 2000; i++) {
                const t = Math.random() * Math.PI * 2;
                const x = 8 * Math.pow(Math.sin(t), 3);
                const y = 6.5 * Math.cos(t) - 2.5 * Math.cos(2*t) - Math.cos(3*t) - 0.5 * Math.cos(4*t);
                points.push(x * 0.8, y * 0.8, (Math.random()-0.5)*2);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(points, 3));

            material = new THREE.PointsMaterial({
                color: 0x00ffcc,
                size: 0.4,
                transparent: true,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            debug("Three.js 初始化成功");
        } catch (e) {
            debug("Three.js 失敗: " + e.message);
        }
    }

    // --- 2. MediaPipe 手勢偵測 ---
    const videoElement = document.getElementById('video-input');
    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 0, // 降低手機負載
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length >= 2) {
            const h1 = results.multiHandLandmarks[0][9];
            const h2 = results.multiHandLandmarks[1][9];
            const dist = Math.sqrt(Math.pow(h1.x - h2.x, 2) + Math.pow(h1.y - h2.y, 2));
            expansion = 1.0 + (dist * 5.0);
        } else {
            expansion = THREE.MathUtils.lerp(expansion, 1.0, 0.1);
        }
    });

    // --- 3. 啟動按鈕邏輯 ---
    document.getElementById('start-btn').addEventListener('click', async () => {
        debug("按鈕已點擊，正在嘗試啟動相機...");
        document.getElementById('start-btn').style.display = 'none';
        
        try {
            // 啟動相機
            const cameraHelper = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 480, height: 640
            });
            
            await cameraHelper.start();
            debug("相機已啟動，加載粒子...");
            
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
            }, 500);

            initThree();
            animate();
        } catch (err) {
            debug("啟動失敗: " + err.name + " - " + err.message);
            console.error(err);
        }
    });

    function animate() {
        requestAnimationFrame(animate);
        if (particles) {
            particles.rotation.y += 0.01;
            particles.scale.set(expansion, expansion, expansion);
        }
        renderer.render(scene, camera);
    }

    // 處理視窗大小改變
    window.addEventListener('resize', () => {
        if (camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });
</script>
</body>
</html>
